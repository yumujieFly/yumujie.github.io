# mq 消息的一致性和有序性  
## 解决重复消息和顺序消息的方式   
    1、版本号：
       每个消息自带一个版本号，下有在消费的时候维护这个版本号，版本号的作用可以将重复的消息解决，但不能解决顺序消息的问题，TCP/IP 协议，如果让乱序的消息最后你能正确的呗组织，那么就应该只接受比当前版本大一的消息，并且在一个seesion周期内要一直保存各个消息的版本号。例如 到来的顺序是21，则把先把2存起来，待1到来之后，先处理1，再处理2 这样重复性和顺序要求就都达到了。
       缺点：
          * 发送方必须要求 消息带上业务的版本号
          * 下游必须存储消息的版本号，对于要严格保证顺序的
  
    2、 状态机：  
       定义一下 在什么状态可以接受什么状态的消息，比如下线，上线，接受状态的时候做一下判断，比如上线只是接受下线的消息，下线只是接受上线的消息，当上线接受上线的时候将消息重新写入到消息队列里
       
    3、 中间件对于重复消息的处理   
       * broker 记录MessageId 直到投递成功后清除，重复的id到来不做处理，这样只要发送者在清除周期里能够感知到消息投递成功，就基本不会在server端产生重复的消息。
       * 对于server投递到consumer的消息，由于不确定对端是在处理过程中还是消息发送丢失的情况下，有必要记录下投递的ip地址，决定重发之前询问这个ip,消息处理成功了吗？如果询问无果，再重发。
